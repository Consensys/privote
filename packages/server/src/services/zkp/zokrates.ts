
import { readFile } from "fs/promises";
import path from "path";
import { initialize } from "zokrates-js";
import fs from "fs";

const getZKP = async () => {
  console.log(process.cwd() )
  const zkPath = path.join(process.cwd(), "src", "services", "zkp");
  const source = (await readFile(path.join(zkPath,"./main.zok" ))).toString();
  const program = (await readFile(path.join(zkPath,"./out" ))).toString("hex");
  const verificationKey = JSON.parse(
    (await readFile(path.join(zkPath,"./verification.key" ))).toString()
  );
  const provingKey = (await readFile(path.join(zkPath,"./proving.key"))).toString("hex");
console.log(verificationKey)
  return {
    program,
    provingKey,
    verificationKey,
  }

}



export const generateProof = async (
  privateKey: string,
  publicKey: string[]
) => {


  const provider = await initialize();

  const artifacts = await getZKP();

  const program = Uint8Array.from(Buffer.from(artifacts.program, "hex"));

  const { witness, output } = provider.computeWitness(program, [
    ...publicKey.flat(),
    privateKey,
    "8",
    "168700",
    "168696",
    "168698",
    "1",
    "0",
    "1",
    "16540640123574156134436876038791482806971768689494387082833631921987005038935",
    "20819045374670962167435360035096875258406992893633759881276124905556507972311",
  ]);



  const provingKey = Uint8Array.from(
    Buffer.from(artifacts.provingKey, "hex")
  );

  const proof = provider.generateProof(
    program,
    witness,
    provingKey
  );


  console.log("verifying....");

  const isVerified = provider.verify(artifacts.verificationKey, proof);
  console.log("isVerified locally", isVerified);
  return provider.utils.formatProof(proof);
};

const v = {
  JUBJUB_C: "8",
  JUBJUB_A: "168700",
  JUBJUB_D: "168696",
  MONT_A: "168698",
  MONT_B: "1",

  INFINITY: ["0", "1"],

  Gu: "16540640123574156134436876038791482806971768689494387082833631921987005038935",
  Gv: "20819045374670962167435360035096875258406992893633759881276124905556507972311",
};

const publicKeyAdmin = [
  "7472897846137136917299651378841383713703769203333490946931226976671716112084",
  "11693132406114319974509904108857219409060008300492408472116800264834907813821",
];

const privatKeyAdmin = 275749831544586485914306141871585880197408108707808041647076271328505907535;

const context = {
  JUBJUB_C: "8",
  JUBJUB_A: "168700",
  JUBJUB_D: "168696",
  MONT_A: "168698",
  MONT_B: "1",
  INFINITY: ["0", "1"],
  Gu: "16540640123574156134436876038791482806971768689494387082833631921987005038935",
  Gv: "20819045374670962167435360035096875258406992893633759881276124905556507972311",
};

PrivatekeyVoter: 41312363009736865636906441516151420855389134349122513854196320281258221252891;
PublickeyCVoter: [
  "15831916220771200049274094396994446260231749081231686098592643491585509753525",
  "21288868507822370435338357986297515715525905368917341599200095016973910902891",
];

// const v = {
//   JUBJUB_C: "8",
//   JUBJUB_A: "168700",
//   JUBJUB_D: "168696",
//   MONT_A: "168698",
//   MONT_B: "1",

//   INFINITY: ["0", "1"],

//   Gu: "16540640123574156134436876038791482806971768689494387082833631921987005038935",
//   Gv: "20819045374670962167435360035096875258406992893633759881276124905556507972311",
// };


// [["0x1c25c40c60d10f2fd34d202bf2cab57d5d4c07cd0173d119a3c2a6869570377b","0x26ba90a2a4dfffe77693cf6e067dff8c53aefbb79ea2563e84472d8893be62bb"],[["0x037c4f7746b86d36387c14450d92fb5084a802aaaacb2bed8f3284d4f7e16bd9","0x24c8706790a6a448ac33c77f6c24c5b3decfcb7e5e417e93dfebaf09f73b87cb"],["0x06b37a3a94aaf6fc809b0bb62782b83e90112437f849956a5d218d1f36314330","0x1bae31307c0269dadae04753859018ece3158b88b4cfae46e683cdd52962e78c"]],["0x2097f432b51cc65a009ed734b3dbafa7dc18340238110d5d20466815d917bd7e","0x204ff8553a0ae2b911ed84925b28e458e8357569ed87d6f72ce51f3eb3a9cfc2"]]


// ["0x108582a28b233e3f89972d4e580c65fb675d1c8c22830a23f98e99e9afdc76d4","0x19da14126a65d68a8b74a6d8882f977c72492dc01fd5399b7f0127b4633ab7bd","0x0000000000000000000000000000000000000000000000000000000000000008","0x00000000000000000000000000000000000000000000000000000000000292fc","0x00000000000000000000000000000000000000000000000000000000000292f8","0x00000000000000000000000000000000000000000000000000000000000292fa","0x0000000000000000000000000000000000000000000000000000000000000001","0x0000000000000000000000000000000000000000000000000000000000000000","0x0000000000000000000000000000000000000000000000000000000000000001","0x2491aba8d3a191a76e35bc47bd9afe6cc88fee14d607cbe779f2349047d5c157","0x2e07297f8d3c3d7818dbddfd24c35583f9a9d4ed0cb0c1d1348dd8f7f99152d7","0x0000000000000000000000000000000000000000000000000000000000000001"]